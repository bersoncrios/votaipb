<div class="manage-container" *ngIf="eleicao$ | async as eleicao; else loading">

  <h1>{{ eleicao.titulo }}</h1>
  <p><strong>Status:</strong> {{ eleicao.status }}</p>

  <div *ngIf="eleicao.cargoAbertoParaVotacao as aberto" class="votacao-aberta-aviso">
    ⚠️ VOTAÇÃO ABERTA: Cargo ID {{ aberto.cargoId }}, Escrutínio Nº {{ aberto.escrutinioNum }}
  </div>

  <hr>

  <h2>Cargos</h2>
  <div class="cargos-lista">

    <div *ngFor="let cargo of eleicao.cargos" class="cargo-card">
      <h3>{{ cargo.titulo }}</h3>

      <button *ngIf="!cargo.vencedor" (click)="onForcarReapuracao(eleicao, cargo)" style="background: #fbc02d; color: #333; margin: 0 2rem 1rem 2rem; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600;">
        Forçar Re-apuração de Vencedor
      </button>
      <div *ngIf="cargo.vencedor; else controlesEscrutinio" class="vencedor-bloco">
        <h4>Eleição Finalizada</h4>
        <p>Vencedor: <strong>{{ cargo.vencedor.nome }}</strong></p>
        <p>(ID: {{ cargo.vencedor.userId }})</p>
      </div>

      <ng-template #controlesEscrutinio>
        <div class="escrutinios-lista">

          <div *ngFor="let escrutinio of cargo.escrutinios" class="escrutinio-card">
            <h4>{{ escrutinio.numero }}º Escrutínio</h4>
            <p><strong>Status:</strong> {{ escrutinio.status }}</p>

            <div class="controles">

              <ng-container *ngIf="escrutinio.status === 'nao_iniciado'">

                <button
                  *ngIf="escrutinio.numero === 3 && escrutinio.candidatos.length === 0"
                  (click)="onPreparar3Escrutinio(eleicao, cargo)"
                  [disabled]="cargo.escrutinios[1].status !== 'fechado'">
                  Preparar 3º Escrutínio (Top 2)
                </button>

                <button
                  (click)="onAbrirEscrutinio(eleicao, cargo, escrutinio)"
                  [disabled]="eleicao.cargoAbertoParaVotacao !== null || (escrutinio.numero === 3 && escrutinio.candidatos.length === 0)">
                  Abrir Votação
                </button>
              </ng-container>

              <button *ngIf="escrutinio.status === 'aberto'"
                      (click)="onFecharEscrutinio(eleicao, cargo, escrutinio)">
                Fechar Votação e Apurar
              </button>

              <div *ngIf="escrutinio.status === 'fechado'" class="apuracao-resultados">
                <strong>Resultados ({{ escrutinio.votos.length }} votos)</strong>

                <button *ngIf="!apuracaoCache.has(cargo.id + '-' + escrutinio.numero)"
                        (click)="onApurar(cargo, escrutinio)">
                  Ver Apuração
                </button>

                <ng-container *ngIf="apuracaoCache.has(cargo.id + '-' + escrutinio.numero)">
                  <ul *ngFor="let item of apuracaoCache.get(cargo.id + '-' + escrutinio.numero)?.votosPorCandidato | keyvalue">
                    <li>
                      {{ getCandidatoNome(cargo, item.key) }}: <strong>{{ item.value }} votos</strong>
                    </li>
                  </ul>
                  <p>Brancos: {{ apuracaoCache.get(cargo.id + '-' + escrutinio.numero)?.totalBrancos }}</p>
                  <p>Nulos: {{ apuracaoCache.get(cargo.id + '-' + escrutinio.numero)?.totalNulos }}</p>
                </ng-container>
              </div>

            </div>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<ng-template #loading>
  <p>Carregando dados da eleição...</p>
</ng-template>
