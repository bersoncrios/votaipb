<div class="manage-container" *ngIf="eleicao$ | async as eleicao; else loading">

  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.5rem;">
    <h1>{{ eleicao.titulo }}</h1>
    <button (click)="onCopiarLink(eleicao.id)" style="background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
      üîó Copiar Link de Vota√ß√£o
    </button>
  </div>

  <p><strong>Status:</strong> {{ eleicao.status }}</p>

  <div *ngIf="eleicao.cargoAbertoParaVotacao as aberto" class="votacao-aberta-aviso">
    ‚ö†Ô∏è VOTA√á√ÉO ABERTA: Cargo ID {{ aberto.cargoId }}, Escrut√≠nio N¬∫ {{ aberto.escrutinioNum }}
  </div>

  <hr>

  <h2>Cargos</h2>
  <div class="cargos-lista">

    <div *ngFor="let cargo of eleicao.cargos" class="cargo-card">
      <h3>{{ cargo.titulo }}</h3>

      <div *ngIf="cargo.vencedor" class="vencedor-bloco">
        <h4>Elei√ß√£o Finalizada</h4>
        <p>Vencedor: <strong>{{ cargo.vencedor.nome }}</strong></p>
        <p>(ID: {{ cargo.vencedor.userId }})</p>
      </div>

      <div class="escrutinios-lista">

        <div *ngFor="let escrutinio of cargo.escrutinios" class="escrutinio-card">
          <h4>{{ escrutinio.numero }}¬∫ Escrut√≠nio</h4>
          <p><strong>Status:</strong> {{ escrutinio.status }}</p>

          <div *ngIf="!cargo.vencedor" class="controles">

            <ng-container *ngIf="escrutinio.status === 'nao_iniciado'">
              <button
                *ngIf="escrutinio.numero === 3 && escrutinio.candidatos.length === 0"
                (click)="onPreparar3Escrutinio(eleicao, cargo)"
                [disabled]="cargo.escrutinios[1].status !== 'fechado'">
                Preparar 3¬∫ Escrut√≠nio (Top 2)
              </button>
              <button
                (click)="onAbrirEscrutinio(eleicao, cargo, escrutinio)"
                [disabled]="eleicao.cargoAbertoParaVotacao !== null || (escrutinio.numero === 3 && escrutinio.candidatos.length === 0)">
                Abrir Vota√ß√£o
              </button>
            </ng-container>

            <button *ngIf="escrutinio.status === 'aberto'"
                    (click)="onFecharEscrutinio(eleicao, cargo, escrutinio)">
              Fechar Vota√ß√£o e Apurar
            </button>
          </div>

          <div *ngIf="escrutinio.status === 'fechado'" class="apuracao-resultados">
            <strong>Resultados ({{ escrutinio.votos.length }} votos)</strong>

            <button *ngIf="!apuracaoOrdenadaCache.has(cargo.id + '-' + escrutinio.numero)"
                    (click)="onApurar(cargo, escrutinio)">
              Ver Apura√ß√£o
            </button>

            <ng-container *ngIf="apuracaoOrdenadaCache.has(cargo.id + '-' + escrutinio.numero)">
              <ul class="lista-resultados-apuracao">
                <li *ngFor="let item of apuracaoOrdenadaCache.get(cargo.id + '-' + escrutinio.numero); let i = index"
                    [class.vencedor-item]="i === 0 && item.votos > 0"
                    [class.outros-item]="i > 0 || item.votos === 0">

                  <span class="nome-candidato">
                    {{ i + 1 }}. {{ item.nome }}
                    <span class="id-candidato">(ID: {{ item.userId }})</span>
                  </span>

                  <strong class="votos-candidato">{{ item.votos }} votos</strong>
                </li>
              </ul>

              <div class="brancos-nulos">
                <p>Brancos: {{ apuracaoCache.get(cargo.id + '-' + escrutinio.numero)?.totalBrancos }}</p>
                <p>Nulos: {{ apuracaoCache.get(cargo.id + '-' + escrutinio.numero)?.totalNulos }}</p>
              </div>
            </ng-container>

          </div> </div> </div> </div> </div> </div>

<ng-template #loading>
  <p>Carregando dados da elei√ß√£o...</p>
</ng-template>
